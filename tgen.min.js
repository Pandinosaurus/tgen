/*
 * tgen.js - the seamless texture generator
 * https://github.com/schalkt/tgen
 *
 * Copyright (c) 2015 Tamas Schalk
 * MIT license
 *
 * @version 0.1
 *
 */
var tgen=function(n,l){var a={};var v=[];var u=[];var h={};var t=0;if(n==undefined){n=128}if(l==undefined){l=n}var p=function(){k.clear();v=[];u=[];t=0;h.start=new Date().getTime()};var k={data:null,pixels:function(){return n*l*4},clear:function(){this.data=new Float32Array(n*l*4)},set:function(w){var A=this.pixels();var x=w.getContext("2d");var y=x.getImageData(0,0,n,l);var z=y.data;while(A--){k.data[A]=z[A]}},opacity:function(w){if(w===undefined){w=0.5}var y=this.pixels();for(var x=-1;x<y;x=x+4){k.data[x]=w}return this}};p();var g=function(z,y){var x={};for(var w in z){x[w]=z[w]}for(var w in y){x[w]=y[w]}return x};var c=function(x,w){return Math.floor(Math.random()*(w-x+1))+x};var d=function(x,w){return Math.random()*(w-x)+x};var r=function(w){if(w===undefined){w=1}if(w===true){w=0.2+(Math.random()/1.5)}return[c(0,255),c(0,255),c(0,255),w]};var s=function(){var x=a.blends.length;var w=c(0,x-1);return a.blends[w]};a.blends=["opacity","multiply","screen","overlay","difference","exclusion","darken","lighten","lineardodge","linearlight","linearburn","softlight"];a.defaults={fill:{blend:"opacity",rgba:[128,128,228,1]},merge:{blend:"opacity",opacity:0.5},noise:{blend:"random",mode:"monochrome",opacity:0.5},colorize:{level:50,rgb:[[128,255],[128,255],[128,255]]},vibrance:{adjust:50},contrast:{adjust:50},threshold:{threshold:96},invert:{},brightness:{adjust:50,legacy:true},waves:{blend:"random",level:50},crosshatch:{blend:"random",level:50},lines:{blend:"softlight",rgba:"random",count:200,sizeMin:10,sizeMax:120},circles:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:15},blobs:{blend:"softlight",rgba:"random",count:20,sizeMin:3,sizeMax:40},squares:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:50}};var e=function(w){if(w==="random"){w=r(true)}if(typeof w[0]=="object"){w[0]=c(w[0][0],w[0][1])}if(typeof w[1]=="object"){w[1]=c(w[1][0],w[1][1])}if(typeof w[2]=="object"){w[2]=c(w[2][0],w[2][1])}if(typeof w[3]=="object"){w[3]=d(w[3][0],w[3][1])}return w};var m=function(w,y,x){if(y===undefined){y=g({},a.defaults[w])}else{y=g(a.defaults[w],y)}if(x!==undefined){y=x(y)}if(y.blend==="random"){y.blend=s()}if(y.blend!==undefined){o.blend=y.blend}else{o.blend=""}if(y.rgba){y.rgba=e(y.rgba);o.rgba=y.rgba}if(y.rgb){y.rgb=e(y.rgb);o.rgba=y.rgb}return y};var i=function(w,x){console.log(t,w,x)};var f=function(w,x){u.push([t,w,x]);i(w,x)};var j={rect:function(G,F,z,w,E){if(E!==undefined){var D=parseInt(-z/2);var C=parseInt(-w/2)}else{var D=0;var C=0}for(var B=0;B<z;B++){for(var A=0;A<w;A++){o.set(D+G+B,C+F+A)}}},circle:function(w,F,C,D){if(D!==undefined){var B=0;var z=0}else{var B=C;var z=C}for(var G=-C;G<C;G++){var A=parseInt(Math.sqrt(C*C-G*G));for(var E=-A;E<A;E++){o.set(w+B+G,F+z+E)}}},line:function(z,E,w,D){var B=Math.sqrt((w-z)*(w-z)+(D-E)*(D-E));var H=(w-z)/B;var G=(D-E)/B;var F=0;var C=0;for(var A=0;A<B;A++){F=z+(H*A);C=E+(G*A);o.set(F,C)}}};var b={luminance:function(w){return(0.21*w[0])+(0.72*w[1])+(0.07*w[2])}};var o={rgba:[0,0,0,1],mixed:[0,0,0,1],blend:"opacity",normalize:function(w){w[0]=Math.round(w[0]);w[1]=Math.round(w[1]);w[2]=Math.round(w[2]);return w},colorize:function(x,w,y){if(y===undefined){y=50}return[x[0]-(x[0]-w[0])*(y/100),x[1]-(x[1]-w[1])*(y/100),x[2]-(x[2]-w[2])*(y/100),w[3]?w[3]:0.5]},pattern:function(A,w){A=parseInt(A);if(A>=0&&A<w){return A}var y=A/w;if(A>=w){var z=Math.floor(y)*(w);var x=(A-z);return x}if(A<0){var z=Math.ceil(y)*(w);var x=w-Math.abs((A-z));if(x>=w){var x=(x-w);return x}return x}},opacity:function(w,x){if(w[3]>1){w[3]=w[3]/255}if(w[3]==1){return[w[0],w[1],w[2],w[3]]}return[w[0]*(w[3])+x[0]*(1-w[3]),w[1]*(w[3])+x[1]*(1-w[3]),w[2]*(w[3])+x[2]*(1-w[3]),w[3]]},calc:function(w,y){switch(this.blend){case"opacity":var x=this.opacity(w,y);break;case"multiply":w[0]=(y[0]*w[0])/255;w[1]=(y[1]*w[1])/255;w[2]=(y[2]*w[2])/255;var x=this.opacity(w,y);break;case"screen":w[0]=255-(((255-y[0])*(255-w[0]))/255);w[1]=255-(((255-y[1])*(255-w[1]))/255);w[2]=255-(((255-y[2])*(255-w[2]))/255);var x=this.opacity(w,y);break;case"overlay":w[0]=(y[0]>128)?255-2*(255-w[0])*(255-y[0])/255:(y[0]*w[0]*2)/255;w[1]=(y[1]>128)?255-2*(255-w[1])*(255-y[1])/255:(y[1]*w[1]*2)/255;w[2]=(y[2]>128)?255-2*(255-w[2])*(255-y[2])/255:(y[2]*w[2]*2)/255;var x=this.opacity(w,y);break;case"difference":w[0]=Math.abs(w[0]-y[0]);w[1]=Math.abs(w[1]-y[1]);w[2]=Math.abs(w[2]-y[2]);var x=this.opacity(w,y);break;case"exclusion":w[0]=128-2*(y[0]-128)*(w[0]-128)/255;w[1]=128-2*(y[1]-128)*(w[1]-128)/255;w[2]=128-2*(y[2]-128)*(w[2]-128)/255;var x=this.opacity(w,y);break;case"darken":w[0]=(w[0]<y[0])?w[0]:y[0];w[1]=(w[1]<y[1])?w[1]:y[1];w[2]=(w[2]<y[2])?w[2]:y[2];var x=this.opacity(w,y);break;case"lighten":w[0]=(w[0]>y[0])?w[0]:y[0];w[1]=(w[1]>y[1])?w[1]:y[1];w[2]=(w[2]>y[2])?w[2]:y[2];var x=this.opacity(w,y);break;case"lineardodge":w[0]=y[0]+w[0];w[1]=y[1]+w[1];w[2]=y[2]+w[2];var x=this.opacity(w,y);break;case"linearlight":w[0]=y[0]+2*w[0]-255;w[1]=y[1]+2*w[1]-255;w[2]=y[2]+2*w[2]-255;var x=this.opacity(w,y);break;case"linearburn":w[0]=y[0]+w[0]-255;w[1]=y[1]+w[1]-255;w[2]=y[2]+w[2]-255;var x=this.opacity(w,y);break;case"softlight":w[0]=(y[0]>128)?255-((255-y[0])*(255-(w[0]-128)))/255:(y[0]*(w[0]+128))/255;w[1]=(y[1]>128)?255-((255-y[1])*(255-(w[1]-128)))/255:(y[1]*(w[1]+128))/255;w[2]=(y[2]>128)?255-((255-y[2])*(255-(w[2]-128)))/255:(y[2]*(w[2]+128))/255;var x=this.opacity(w,y);break;default:var x=[w[0],w[1],w[2],w[3]];break}return x},set:function(w,A){w=this.pattern(w,n);A=this.pattern(A,l);this.mixed=this.calc(this.rgba,this.get(w,A));var z=A*n*4+w*4;k.data[z]=this.mixed[0];k.data[z+1]=this.mixed[1];k.data[z+2]=this.mixed[2];k.data[z+3]=this.mixed[3]},get:function(w,A){w=this.pattern(w,n);A=this.pattern(A,l);var z=A*n*4+w*4;return[k.data[z],k.data[z+1],k.data[z+2],k.data[z+3]]}};var q=function(z){for(var w=0;w<n;w++){for(var B=0;B<l;B++){var A=o.get(w,B);A=z(A,w,B);o.rgba=A;o.set(w,B)}}};a.merge=function(C){C=m("merge",C);if(v[C.layer]===undefined){return this}var z=v[C.layer].getContext("2d");var A=z.getImageData(0,0,n,l);var E=A.data;for(var D=0;D<l;D++){for(var w=0;w<n;w++){var B=D*n*4+w*4;o.rgba=[E[B],E[B+1],E[B+2],E[B+3]];o.rgba[3]=(o.rgba[3]>1)?o.rgba[3]/255:o.rgba[3];o.set(w,D)}}f("merge",C);return this};a.copy=function(x){var A=k.pixels();var w=v[x].getContext("2d");var y=w.getImageData(0,0,n,l);var z=y.data;while(A--){k.data[A]=z[A]}f("copy",x);return this};a.brightness=function(w){w=m("brightness",w);o.blend="";q(function(x){if(w.legacy===true){return[Math.min(x[0]+w.adjust,255),Math.min(x[1]+w.adjust,255),Math.min(x[2]+w.adjust,255),x[3]]}else{w.adjust=Math.pow((w.adjust+100)/100,2);return[((((x[0]/255)-0.5)*w.adjust)+0.5)*255,((((x[1]/255)-0.5)*w.adjust)+0.5)*255,((((x[2]/255)-0.5)*w.adjust)+0.5)*255,x[3]]}});f("brightness",w);return this};a.contrast=function(x){x=m("contrast",x);var w=(100+x.adjust)/100;o.blend="";q(function(y){y[0]=((((y[0]/255)-0.5)*w)+0.5)*255;y[1]=((((y[1]/255)-0.5)*w)+0.5)*255;y[2]=((((y[2]/255)-0.5)*w)+0.5)*255;return[Math.max(Math.min(y[0],255),0),Math.max(Math.min(y[1],255),0),Math.max(Math.min(y[2],255),0),y[3]]});f("contrast",x);return this};a.grayscale=function(w){if(!w){w="average"}o.blend="";switch(w){case"ligthness":q(function(x){var y=Math.max(x[0],x[1],x[2])+Math.min(x[0],x[1],x[2]);return[y,y,y,x[3]]});break;case"average":q(function(x){var y=(x[0]+x[1]+x[2])/3;return[y,y,y,x[3]]});break;case"luminosity":q(function(y){var x=b.luminance(y);return[x,x,x,y[3]]});break}f("grayscale",w);return this};a.colorize=function(w){w=m("colorize",w);o.blend="";q(function(x){return o.colorize(x,w.rgb,w.level)});f("colorize",w);return this};a.invert=function(){params=m("invert",{});o.blend="";q(function(w){return[255-w[0],255-w[1],255-w[2],w[3]]});f("invert",params);return this};a.threshold=function(w){params=m("threshold",{},function(x){if(w!==undefined){x.threshold=w}return x});o.blend="";q(function(x){var y=((0.2126*x[0])+(0.7152*x[1])+(0.0722*x[2])<=params.threshold)?0:255;return[y,y,y,1]});f("threshold",params);return this};a.vibrance=function(x){x=m("vibrance",x);var w=x.adjust*-1;o.blend="";q(function(z){var A=(z[0]+z[1]+z[2])/3;var y=Math.max(z[0],z[1],z[2]);var B=((Math.abs(y-A)*2/255)*w)/100;if(z[0]!==y){z[0]+=(y-z[0])*B}if(z[1]!==y){z[1]+=(y-z[1])*B}if(z[2]!==y){z[2]+=(y-z[2])*B}return[z[0],z[1],z[2],z[3]]});f("vibrance",x);return this};a.waves=function(z){params=m("waves",z,function(y){if(y.xsines===undefined){y.xsines=c(1,10)}else{if(typeof y.xsines=="object"){y.xsines=c(y.xsines[0],y.xsines[1])}}if(y.ysines===undefined){y.ysines=c(1,10)}else{if(typeof y.ysines=="object"){y.ysines=c(y.ysines[0],y.ysines[1])}}if(y.rgba===undefined){var x=(y.opacity!==undefined)?y.opacity:1;y.rgba=e([[0,255],[0,255],[0,255],x])}return y});for(var w=0;w<n;w++){for(var B=0;B<l;B++){var A=127+63.5*Math.sin(w/n*params.xsines*2*3.1415)+63.5*Math.sin(B/l*params.ysines*2*3.1415);o.rgba=o.colorize([A,A,A,1],params.rgba,params.level);o.set(w,B)}}f("waves",params);return this};a.crosshatch=function(z){params=m("crosshatch",z,function(x){if(x.xadjust==undefined){x.xadjust=c(1,10)}if(x.yadjust===undefined){x.yadjust=c(1,10)}if(x.rgba===undefined){x.rgba=[c(0,255),c(0,255),c(0,255),1]}return x});for(var w=0;w<n;w++){for(var B=0;B<l;B++){var A=127+63.5*Math.sin(w*w/params.xadjust)+63.5*Math.cos(B*B/params.yadjust);o.rgba=o.colorize([A,A,A,1],params.rgba,params.level);o.set(w,B)}}f("crosshatch",params);return this};a.squares=function(D){D=m("squares",D);D.elements=[];var z=parseInt((D.sizeMin/100)*n);var C=parseInt((D.sizeMax/100)*l);for(var B=0;B<D.count;B++){if(D.origin=="random"){var w=c(0,n);var E=c(0,l)}else{var w=parseInt((D.origin[0]/100)*n);var E=parseInt((D.origin[1]/100)*l)}var A=c(z,C);j.rect(w,E,A,A,false);D.elements.push({x:w,y:E,size:A})}f("squares",D);return this};a.circles=function(D){D=m("circles",D);D.elements=[];var z=parseInt((D.sizeMin/100)*n);var C=parseInt((D.sizeMax/100)*l);for(var B=0;B<D.count;B++){if(D.origin=="random"){var w=c(0,n);var E=c(0,l)}else{var w=parseInt((D.origin[0]/100)*n);var E=parseInt((D.origin[1]/100)*l)}var A=c(z,C);j.circle(w,E,A,true);D.elements.push({x:w,y:E,size:A})}f("circles",D);return this};a.lines=function(B){B=m("lines",B,function(C){C.s1=c(5,32);C.c1=c(5,32);return C});for(var z=0;z<B.count;z++){var x=n/2+Math.sin(z/B.s1)*n*0.7;var A=l/2+Math.cos(z/B.c1)*l*0.7;var w=n/2+Math.sin(z/B.c1)*n*0.7;var y=l/2+Math.cos(z/B.s1)*l*0.7;j.line(x,A,w,y)}f("lines",B);return this};a.noise=function(A){A=m("noise",A);for(var w=0;w<n;w++){for(var B=0;B<l;B++){if(A.mode=="color"){o.rgba=[c(0,255),c(0,255),c(0,255),A.opacity]}else{var z=c(0,255);o.rgba=[z,z,z,A.opacity]}o.set(w,B)}}f("noise",A);return this};a.test=function(){n=200;l=200;o.blend="opacity";o.rgba=[255,255,155,1];j.rect(1,1,n-2,l-2);var w=20;o.rgba=[0,150,0,0.6];j.rect(2,2,w,w);j.rect(n-w-2,2,w,w);j.rect(2,l-2-w,w,w);j.rect(n-2-w,l-2-w,w,w);o.rgba=[20,20,10,0.2];j.rect(n/2,l/2,178,178,true);o.rgba=[10,20,210,0.7];j.rect(n-5,l-5,10,10);var w=20;o.rgba=[0,0,0,1];j.line(w,w,n-w,l-w);j.line(n-w,w,w,l-w);j.line(0,l/2,n,l/2);j.line(n/2,0,n/2,l);o.rgba=[255,55,55,0.5];j.rect(10,10,n-20,l-20);o.rgba=[0,0,255,0.3];j.rect(n-2,l-2,4,4);o.rgba=[255,255,255,1];o.set(0,0);o.set(n-1,0);o.set(0,l-1);o.set(n-1,l-1);o.rgba=[25,25,0,0.2];j.circle(n/4,l/4,n/4,true);o.rgba=[255,255,0,0.1];j.circle(n,l,n,true);this.brightness(50,true);this.vibrance(100);this.contrast(20);return this};a.fill=function(w){m("fill",w);j.rect(1,1,n,l);f("fill",w);return this};a.toImage=function(x){var z=x.createImageData(n,l);var y=z.data;var A=k.pixels();for(var w=0;w<A;w+=4){y[w]=k.data[w];y[w+1]=k.data[w+1];y[w+2]=k.data[w+2];y[w+3]=255}return z};a.toCanvas=function(){var w=document.createElement("canvas");w.width=n;w.height=l;var x=w.getContext("2d");var y=this.toImage(x);x.putImageData(y,0,0);return w};a.getCanvas=function(w){if(w){w(v[v.length-1])}return this};a.getPhases=function(z){if(z){var w=[];var y=v.length;for(var x=0;x<y;x++){w.push(v[x])}z(w)}return this};a.stat=function(w){h.stop=new Date().getTime();h.elapsed=(h.stop-h.start)/1000;if(w){w(h)}return this};a.save=function(){return{width:n,height:l,items:u}};a.params=function(z,y){var D=0;if(z.width!=undefined){n=z.width}if(z.height!=undefined){l=z.height}if(y!=true){p()}for(var A in z.items){t=z.items[A][0];var B=z.items[A][1];var x=z.items[A][2];if(D!=t){if(v[t]!=undefined){k.set(v[t])}else{k.clear()}D=t}switch(B){case"call":if(x){window[x](a)}break;case"merge":for(var w in x){var C={layer:x[w][0]};if(x[w][1]!==undefined){C.blend=x[w][1]}if(x[w][2]!==undefined){C.opacity=x[w][2]}a.merge(C)}break;default:if(a[B]==undefined){console.warn("undefined effect: "+B)}else{a[B](x)}break}v[t]=a.toCanvas()}return this};return a};