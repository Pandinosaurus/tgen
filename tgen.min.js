/*
 * tgen.js - the seamless texture generator
 * https://github.com/schalkt/tgen
 *
 * Copyright (c) 2015 Tamas Schalk
 * MIT license
 *
 * @version 0.1
 *
 */
var tgen=function(o,m){var a={};var x=[];var v=[];var i={};var u=0;var w=true;a.blends=["opacity","multiply","screen","overlay","difference","exclusion","darken","lighten","lineardodge","linearlight","linearburn","softlight"];if(o==undefined){o=128}if(m==undefined){m=o}var t=function(){l.clear();x=[];v=[];u=0;i.start=new Date().getTime()};var l={data:null,pixels:function(){return o*m*4},clear:function(){this.data=new Float32Array(o*m*4)},set:function(y){var C=this.pixels();var z=y.getContext("2d");var A=z.getImageData(0,0,o,m);var B=A.data;while(C--){l.data[C]=B[C]}},opacity:function(y){if(y===undefined){y=0.5}var A=this.pixels();for(var z=0;z<A;z=z+4){l.data[z]=y}return this}};t();var h=function(B,A){var z={};for(var y in B){z[y]=B[y]}for(var y in A){z[y]=A[y]}return z};var c=function(z,y){return Math.floor(Math.random()*(y-z+1))+z};var e=function(z,y){return Math.random()*(y-z)+z};var r=function(y){if(y===undefined){y=1}if(y===true){y=0.2+(Math.random()/1.5)}return[c(0,255),c(0,255),c(0,255),y]};var d=function(y){if(y!==undefined){return y}y=[c(0,1),c(0,1),c(0,1),e(0.3,1)];if(y[0]+y[1]+y[2]==0){y[2]=1}return y};var s=function(){var z=a.blends.length;var y=c(0,z-1);return a.blends[y]};a.defaults={fill:{blend:"opacity",rgba:[128,128,228,1]},merge:{blend:"opacity",opacity:0.5},noise:{blend:"random",mode:"monochrome",opacity:0.5},colorize:{level:50,rgb:"random"},vibrance:{adjust:50},contrast:{adjust:50},threshold:{threshold:96},invert:{},brightness:{adjust:50,legacy:true},waves:{blend:"random",level:50},crosshatch:{blend:"random",level:50},lines:{blend:"softlight",rgba:"random",count:200,sizeMin:10,sizeMax:120},circles:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:15},spheres:{blend:"lighten",origin:"random",count:21,sizeMin:20,sizeMax:70},squares:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:50}};var f=function(y){if(y==="random"){y=r(true)}if(typeof y[0]=="object"){y[0]=c(y[0][0],y[0][1])}if(typeof y[1]=="object"){y[1]=c(y[1][0],y[1][1])}if(typeof y[2]=="object"){y[2]=c(y[2][0],y[2][1])}if(typeof y[3]=="object"){y[3]=e(y[3][0],y[3][1])}return y};var n=function(y,A,z){if(A===undefined){A=h({},a.defaults[y])}else{A=h(a.defaults[y],A)}if(z!==undefined){A=z(A)}if(typeof A.count=="object"){A.count=c(A.count[0],A.count[1])}if(A.blend===undefined||A.blend===null){A.blend=""}if(A.blend==="random"){A.blend=s()}if(A.blend!==undefined){p.blend=A.blend}else{p.blend=""}if(A.rgba){A.rgba=f(A.rgba);p.rgba=A.rgba}if(A.rgb){A.rgb=f(A.rgb);p.rgba=A.rgb}return A};var j=function(y,z){if(w){console.log(u,y,z)}};var g=function(y,z){v.push([u,y,z]);j(y,z)};var k={rect:function(H,G,A,z,F){if(F!==undefined){var E=parseInt(-A/2);var D=parseInt(-z/2)}else{var E=0;var D=0}for(var C=0;C<A;C++){for(var B=0;B<z;B++){p.set(E+H+C,D+G+B)}}},circle:function(z,G,D,E){if(E!==undefined){var C=0;var A=0}else{var C=D;var A=D}for(var H=-D;H<D;H++){var B=parseInt(Math.sqrt(D*D-H*H));for(var F=-B;F<B;F++){p.set(z+C+H,G+A+F)}}},line:function(A,F,z,E){var C=Math.sqrt((z-A)*(z-A)+(E-F)*(E-F));var I=(z-A)/C;var H=(E-F)/C;var G=0;var D=0;for(var B=0;B<C;B++){G=A+(I*B);D=F+(H*B);p.set(G,D)}},sphere:function(z,I,E,F,A){if(F!==undefined){var D=0;var B=0}else{var D=E;var B=E}for(var J=-E;J<E;J++){var C=parseInt(Math.sqrt(E*E-J*J));for(var H=-C;H<C;H++){var G=Math.min(255,Math.max(0,(255-255*Math.sqrt((H*H)+(J*J))/(E/2))));p.rgba=[(A[0]==1)?G:0,(A[1]==1)?G:0,(A[2]==1)?G:0,A[3]];p.set(z+D+J,I+B+H)}}}};var b={luminance:function(y){return(0.21*y[0])+(0.72*y[1])+(0.07*y[2])}};var p={rgba:[0,0,0,1],mixed:[0,0,0,1],blend:"opacity",normalize:function(y){y[0]=Math.round(y[0]);y[1]=Math.round(y[1]);y[2]=Math.round(y[2]);return y},colorize:function(z,y,A){if(A===undefined){A=50}return[z[0]-(z[0]-y[0])*(A/100),z[1]-(z[1]-y[1])*(A/100),z[2]-(z[2]-y[2])*(A/100),y[3]?y[3]:0.5]},pattern:function(C,y){C=parseInt(C);if(C>=0&&C<y){return C}var A=C/y;if(C>=y){var B=Math.floor(A)*(y);var z=(C-B);return z}if(C<0){var B=Math.ceil(A)*(y);var z=y-Math.abs((C-B));if(z>=y){var z=(z-y);return z}return z}},opacity:function(y,z){if(y[3]>1){y[3]=y[3]/255}if(y[3]==1){return[y[0],y[1],y[2],y[3]]}return[y[0]*(y[3])+z[0]*(1-y[3]),y[1]*(y[3])+z[1]*(1-y[3]),y[2]*(y[3])+z[2]*(1-y[3]),y[3]]},calc:function(y,A){switch(this.blend){case"opacity":var z=this.opacity(y,A);break;case"multiply":y[0]=(A[0]*y[0])/255;y[1]=(A[1]*y[1])/255;y[2]=(A[2]*y[2])/255;var z=this.opacity(y,A);break;case"screen":y[0]=255-(((255-A[0])*(255-y[0]))/255);y[1]=255-(((255-A[1])*(255-y[1]))/255);y[2]=255-(((255-A[2])*(255-y[2]))/255);var z=this.opacity(y,A);break;case"overlay":y[0]=(A[0]>128)?255-2*(255-y[0])*(255-A[0])/255:(A[0]*y[0]*2)/255;y[1]=(A[1]>128)?255-2*(255-y[1])*(255-A[1])/255:(A[1]*y[1]*2)/255;y[2]=(A[2]>128)?255-2*(255-y[2])*(255-A[2])/255:(A[2]*y[2]*2)/255;var z=this.opacity(y,A);break;case"difference":y[0]=Math.abs(y[0]-A[0]);y[1]=Math.abs(y[1]-A[1]);y[2]=Math.abs(y[2]-A[2]);var z=this.opacity(y,A);break;case"exclusion":y[0]=128-2*(A[0]-128)*(y[0]-128)/255;y[1]=128-2*(A[1]-128)*(y[1]-128)/255;y[2]=128-2*(A[2]-128)*(y[2]-128)/255;var z=this.opacity(y,A);break;case"darken":y[0]=(y[0]<A[0])?y[0]:A[0];y[1]=(y[1]<A[1])?y[1]:A[1];y[2]=(y[2]<A[2])?y[2]:A[2];var z=this.opacity(y,A);break;case"lighten":y[0]=(y[0]>A[0])?y[0]:A[0];y[1]=(y[1]>A[1])?y[1]:A[1];y[2]=(y[2]>A[2])?y[2]:A[2];var z=this.opacity(y,A);break;case"lineardodge":y[0]=A[0]+y[0];y[1]=A[1]+y[1];y[2]=A[2]+y[2];var z=this.opacity(y,A);break;case"linearlight":y[0]=A[0]+2*y[0]-255;y[1]=A[1]+2*y[1]-255;y[2]=A[2]+2*y[2]-255;var z=this.opacity(y,A);break;case"linearburn":y[0]=A[0]+y[0]-255;y[1]=A[1]+y[1]-255;y[2]=A[2]+y[2]-255;var z=this.opacity(y,A);break;case"softlight":y[0]=(A[0]>128)?255-((255-A[0])*(255-(y[0]-128)))/255:(A[0]*(y[0]+128))/255;y[1]=(A[1]>128)?255-((255-A[1])*(255-(y[1]-128)))/255:(A[1]*(y[1]+128))/255;y[2]=(A[2]>128)?255-((255-A[2])*(255-(y[2]-128)))/255:(A[2]*(y[2]+128))/255;var z=this.opacity(y,A);break;default:var z=[y[0],y[1],y[2],y[3]];break}return z},set:function(z,B){z=this.pattern(z,o);B=this.pattern(B,m);this.mixed=this.calc(this.rgba,this.get(z,B));var A=B*o*4+z*4;l.data[A]=this.mixed[0];l.data[A+1]=this.mixed[1];l.data[A+2]=this.mixed[2];l.data[A+3]=this.mixed[3]},get:function(z,B){z=this.pattern(z,o);B=this.pattern(B,m);var A=B*o*4+z*4;return[l.data[A],l.data[A+1],l.data[A+2],l.data[A+3]]}};var q=function(B){for(var z=0;z<o;z++){for(var C=0;C<m;C++){var A=p.get(z,C);A=B(A,z,C);p.rgba=A;p.set(z,C)}}};a.merge=function(D){D=n("merge",D);if(x[D.layer]===undefined){return this}var A=x[D.layer].getContext("2d");var B=A.getImageData(0,0,o,m);var F=B.data;for(var E=0;E<m;E++){for(var z=0;z<o;z++){var C=E*o*4+z*4;p.rgba=[F[C],F[C+1],F[C+2],F[C+3]];p.rgba[3]=(p.rgba[3]>1)?p.rgba[3]/255:p.rgba[3];p.set(z,E)}}g("merge",D);return this};a.copy=function(z){var C=l.pixels();var y=x[z].getContext("2d");var A=y.getImageData(0,0,o,m);var B=A.data;while(C--){l.data[C]=B[C]}g("copy",z);return this};a.brightness=function(y){y=n("brightness",y);p.blend="";q(function(z){if(y.legacy===true){return[Math.min(z[0]+y.adjust,255),Math.min(z[1]+y.adjust,255),Math.min(z[2]+y.adjust,255),z[3]]}else{y.adjust=Math.pow((y.adjust+100)/100,2);return[((((z[0]/255)-0.5)*y.adjust)+0.5)*255,((((z[1]/255)-0.5)*y.adjust)+0.5)*255,((((z[2]/255)-0.5)*y.adjust)+0.5)*255,z[3]]}});g("brightness",y);return this};a.contrast=function(z){z=n("contrast",z);var y=(100+z.adjust)/100;p.blend="";q(function(A){A[0]=((((A[0]/255)-0.5)*y)+0.5)*255;A[1]=((((A[1]/255)-0.5)*y)+0.5)*255;A[2]=((((A[2]/255)-0.5)*y)+0.5)*255;return[Math.max(Math.min(A[0],255),0),Math.max(Math.min(A[1],255),0),Math.max(Math.min(A[2],255),0),A[3]]});g("contrast",z);return this};a.grayscale=function(y){if(!y){y="average"}p.blend="";switch(y){case"ligthness":q(function(z){var A=Math.max(z[0],z[1],z[2])+Math.min(z[0],z[1],z[2]);return[A,A,A,z[3]]});break;case"average":q(function(z){var A=(z[0]+z[1]+z[2])/3;return[A,A,A,z[3]]});break;case"luminosity":q(function(A){var z=b.luminance(A);return[z,z,z,A[3]]});break}g("grayscale",y);return this};a.colorize=function(y){y=n("colorize",y);p.blend="";q(function(z){return p.colorize(z,y.rgb,y.level)});g("colorize",y);return this};a.invert=function(){params=n("invert",{});p.blend="";q(function(y){return[255-y[0],255-y[1],255-y[2],y[3]]});g("invert",params);return this};a.threshold=function(y){params=n("threshold",{},function(z){if(y!==undefined){z.threshold=y}return z});p.blend="";q(function(z){var A=((0.2126*z[0])+(0.7152*z[1])+(0.0722*z[2])<=params.threshold)?0:255;return[A,A,A,1]});g("threshold",params);return this};a.vibrance=function(z){z=n("vibrance",z);var y=z.adjust*-1;p.blend="";q(function(B){var C=(B[0]+B[1]+B[2])/3;var A=Math.max(B[0],B[1],B[2]);var D=((Math.abs(A-C)*2/255)*y)/100;if(B[0]!==A){B[0]+=(A-B[0])*D}if(B[1]!==A){B[1]+=(A-B[1])*D}if(B[2]!==A){B[2]+=(A-B[2])*D}return[B[0],B[1],B[2],B[3]]});g("vibrance",z);return this};a.waves=function(A){params=n("waves",A,function(D){if(D.xsines===undefined){D.xsines=c(1,10)}else{if(typeof D.xsines=="object"){D.xsines=c(D.xsines[0],D.xsines[1])}}if(D.ysines===undefined){D.ysines=c(1,10)}else{if(typeof D.ysines=="object"){D.ysines=c(D.ysines[0],D.ysines[1])}}if(D.rgba===undefined){var y=(D.opacity!==undefined)?D.opacity:1;D.rgba=f([[0,255],[0,255],[0,255],y])}return D});for(var z=0;z<o;z++){for(var C=0;C<m;C++){var B=127+63.5*Math.sin(z/o*params.xsines*2*3.1415)+63.5*Math.sin(C/m*params.ysines*2*3.1415);p.rgba=p.colorize([B,B,B,1],params.rgba,params.level);p.set(z,C)}}g("waves",params);return this};a.spheres=function(E){E=n("spheres",E,function(y){y.rgba=d(y.rgba);return y});E.elements=[];var A=parseInt((E.sizeMin/100)*o);var D=parseInt((E.sizeMax/100)*m);for(var C=0;C<E.count;C++){if(E.origin=="random"){var z=c(0,o);var F=c(0,m)}else{var z=parseInt((E.origin[0]/100)*o);var F=parseInt((E.origin[1]/100)*m)}var B=c(A,D);k.sphere(z,F,B,true,E.rgba);E.elements.push({x:z,y:F,size:B})}g("spheres",E);return this};a.crosshatch=function(A){params=n("crosshatch",A,function(y){if(y.xadjust==undefined){y.xadjust=c(1,10)}if(y.yadjust===undefined){y.yadjust=c(1,10)}if(y.rgba===undefined){y.rgba=[c(0,255),c(0,255),c(0,255),1]}return y});for(var z=0;z<o;z++){for(var C=0;C<m;C++){var B=127+63.5*Math.sin(z*z/params.xadjust)+63.5*Math.cos(C*C/params.yadjust);p.rgba=p.colorize([B,B,B,1],params.rgba,params.level);p.set(z,C)}}g("crosshatch",params);return this};a.squares=function(E){E=n("squares",E);E.elements=[];var A=parseInt((E.sizeMin/100)*o);var D=parseInt((E.sizeMax/100)*m);for(var C=0;C<E.count;C++){if(E.origin=="random"){var z=c(0,o);var F=c(0,m)}else{var z=parseInt((E.origin[0]/100)*o);var F=parseInt((E.origin[1]/100)*m)}var B=c(A,D);k.rect(z,F,B,B,false);E.elements.push({x:z,y:F,size:B})}g("squares",E);return this};a.circles=function(E){E=n("circles",E);E.elements=[];var A=parseInt((E.sizeMin/100)*o);var D=parseInt((E.sizeMax/100)*m);for(var C=0;C<E.count;C++){if(E.origin=="random"){var z=c(0,o);var F=c(0,m)}else{var z=parseInt((E.origin[0]/100)*o);var F=parseInt((E.origin[1]/100)*m)}var B=c(A,D);k.circle(z,F,B,true);E.elements.push({x:z,y:F,size:B})}g("circles",E);return this};a.lines=function(D){D=n("lines",D,function(E){E.s1=c(5,32);E.c1=c(5,32);return E});for(var B=0;B<D.count;B++){var z=o/2+Math.sin(B/D.s1)*o*0.7;var C=m/2+Math.cos(B/D.c1)*m*0.7;var y=o/2+Math.sin(B/D.c1)*o*0.7;var A=m/2+Math.cos(B/D.s1)*m*0.7;k.line(z,C,y,A)}g("lines",D);return this};a.noise=function(B){B=n("noise",B);for(var z=0;z<o;z++){for(var C=0;C<m;C++){if(B.mode=="color"){p.rgba=[c(0,255),c(0,255),c(0,255),B.opacity]}else{var A=c(0,255);p.rgba=[A,A,A,B.opacity]}p.set(z,C)}}g("noise",B);return this};a.test=function(){o=200;m=200;p.blend="opacity";p.rgba=[255,255,155,1];k.rect(1,1,o-2,m-2);var y=20;p.rgba=[0,150,0,0.6];k.rect(2,2,y,y);k.rect(o-y-2,2,y,y);k.rect(2,m-2-y,y,y);k.rect(o-2-y,m-2-y,y,y);p.rgba=[20,20,10,0.2];k.rect(o/2,m/2,178,178,true);p.rgba=[10,20,210,0.7];k.rect(o-5,m-5,10,10);var y=20;p.rgba=[0,0,0,1];k.line(y,y,o-y,m-y);k.line(o-y,y,y,m-y);k.line(0,m/2,o,m/2);k.line(o/2,0,o/2,m);p.rgba=[255,55,55,0.5];k.rect(10,10,o-20,m-20);p.rgba=[0,0,255,0.3];k.rect(o-2,m-2,4,4);p.rgba=[255,255,255,1];p.set(0,0);p.set(o-1,0);p.set(0,m-1);p.set(o-1,m-1);p.rgba=[25,25,0,0.2];k.circle(o/4,m/4,o/4,true);p.rgba=[255,255,0,0.1];k.circle(o,m,o,true);this.brightness(50,true);this.vibrance(100);this.contrast(20);return this};a.fill=function(y){n("fill",y);k.rect(1,1,o,m);g("fill",y);return this};a.toImage=function(z){var B=z.createImageData(o,m);var A=B.data;var C=l.pixels();for(var y=0;y<C;y+=4){A[y]=l.data[y];A[y+1]=l.data[y+1];A[y+2]=l.data[y+2];A[y+3]=255}return B};a.toCanvas=function(){var y=document.createElement("canvas");y.width=o;y.height=m;var z=y.getContext("2d");var A=this.toImage(z);z.putImageData(A,0,0);return y};a.getCanvas=function(y){if(y){y(x[x.length-1])}return this};a.getPhases=function(B){if(B){var y=[];var A=x.length;for(var z=0;z<A;z++){y.push(x[z])}B(y)}return this};a.stat=function(y){i.stop=new Date().getTime();i.elapsed=(i.stop-i.start)/1000;if(y){y(i)}return this};a.save=function(){return{width:o,height:m,items:v}};a.params=function(B,A){var F=0;if(B.width!=undefined){o=B.width}if(B.height!=undefined){m=B.height}if(A!=true){t()}for(var C in B.items){u=B.items[C][0];var D=B.items[C][1];var z=B.items[C][2];if(F!=u){if(x[u]!=undefined){l.set(x[u])}else{l.clear()}F=u}switch(D){case"merge":for(var y in z){var E={layer:z[y][0]};if(z[y][1]!==undefined){E.blend=z[y][1]}if(z[y][2]!==undefined){E.opacity=z[y][2]}a.merge(E)}break;default:if(a[D]==undefined){console.warn("undefined effect: "+D)}else{a[D](z)}break}x[u]=a.toCanvas()}return this};return a};