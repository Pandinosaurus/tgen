var tgen=function(p,n){var b={};var B=[];var z=[];var i={};var y=0;var A=false;var k=15;var w="history";var r=[];b.blends=["opacity","multiply","screen","overlay","difference","exclusion","darken","lighten","lineardodge","linearlight","linearburn","softlight"];var x=function(){if(p==undefined){p=256}if(p<1){p=256}if(n<1){n=256}if(p>1024){p=1024}if(n>1024){n=1024}if(n==undefined){n=p}};x();var v=function(){m.clear();B=[];z=[];y=0;i.start=new Date().getTime()};var m={data:null,pixels:function(){return p*n*4},clear:function(){this.data=new Float32Array(p*n*4)},set:function(C){var G=this.pixels();var D=C.getContext("2d");var E=D.getImageData(0,0,p,n);var F=E.data;while(G--){m.data[G]=F[G]}},opacity:function(C){if(C===undefined){C=0.5}var E=this.pixels();for(var D=0;D<E;D=D+4){m.data[D]=C}return this}};v();var h=function(F,E){var D={};for(var C in F){D[C]=F[C]}for(var C in E){D[C]=E[C]}return D};var d=function(D,C){return Math.floor(Math.random()*(C-D+1))+D};var e=function(D,C){return Math.random()*(C-D)+D};var t=function(C){if(C===undefined){C=1}if(C===true){C=0.5+(Math.random()/2)}return[d(0,255),d(0,255),d(0,255),C]};var u=function(){var D=b.blends.length;var C=d(0,D-1);return b.blends[C]};b.defaults={fill:{blend:"opacity",rgba:[128,128,228,1]},merge:{blend:"opacity",opacity:0.5},noise:{blend:"random",mode:"monochrome",opacity:0.5},colorize:{level:50,rgb:"random"},vibrance:{adjust:50},contrast:{adjust:50},threshold:{threshold:96},invert:{},brightness:{adjust:50,legacy:true},waves:{blend:"random",level:50},crosshatch:{blend:"random",level:50},lines:{blend:"softlight",rgba:"random",count:200,sizeMin:10,sizeMax:120},circles:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:15},spheres:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:20,sizeMax:70},squares:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:50}};var f=function(C){if(C==="random"){C=t(true)}if(typeof C[0]=="object"){C[0]=d(C[0][0],C[0][1])}if(typeof C[1]=="object"){C[1]=d(C[1][0],C[1][1])}if(typeof C[2]=="object"){C[2]=d(C[2][0],C[2][1])}if(typeof C[3]=="object"){C[3]=e(C[3][0],C[3][1])}return C};var o=function(D,F,E){if(F===undefined){F=h({},b.defaults[D])}else{F=h(b.defaults[D],F)}if(E!==undefined){F=E(F)}if(typeof F.count=="object"){F.count=d(F.count[0],F.count[1])}if(F.blend===undefined||F.blend===null){F.blend=""}if(F.blend==="random"){F.blend=u()}if(typeof F.blend=="object"){var C=F.blend.length;F.blend=F.blend[d(0,C-1)]}if(F.blend!==undefined){q.blend=F.blend}else{q.blend=""}if(F.rgba){F.rgba=f(F.rgba);q.rgba=F.rgba}if(F.rgb){F.rgb=f(F.rgb);q.rgba=F.rgb}return F};var j=function(C,D){if(A){console.log(y,C,D)}};var g=function(C,D){z.push([y,C,D]);j(C,D)};var l={rect:function(K,J,D,C,I){if(I!==undefined){var H=parseInt(-D/2);var G=parseInt(-C/2)}else{var H=0;var G=0}for(var F=0;F<D;F++){for(var E=0;E<C;E++){q.set(H+K+F,G+J+E)}}},circle:function(C,J,G,H){if(H!==undefined){var F=0;var D=0}else{var F=G;var D=G}for(var K=-G;K<G;K++){var E=parseInt(Math.sqrt(G*G-K*K));for(var I=-E;I<E;I++){q.set(C+F+K,J+D+I)}}},line:function(D,I,C,H){var F=Math.sqrt((C-D)*(C-D)+(H-I)*(H-I));var L=(C-D)/F;var K=(H-I)/F;var J=0;var G=0;for(var E=0;E<F;E++){J=D+(L*E);G=I+(K*E);q.set(J,G)}},sphere:function(C,L,H,I,D){if(I!==undefined){var G=0;var E=0}else{var G=H;var E=H}for(var M=-H;M<H;M++){var F=parseInt(Math.sqrt(H*H-M*M));for(var K=-F;K<F;K++){var J=Math.min(255,Math.max(0,(255-255*Math.sqrt((K*K)+(M*M))/(H/2))));q.rgba=[(D[0]/255)*J,(D[1]/255)*J,(D[2]/255)*J,D[3]];q.set(C+G+M,L+E+K)}}}};var c={luminance:function(C){return(0.21*C[0])+(0.72*C[1])+(0.07*C[2])}};var q={rgba:[0,0,0,1],mixed:[0,0,0,1],blend:"opacity",normalize:function(C){C[0]=Math.round(C[0]);C[1]=Math.round(C[1]);C[2]=Math.round(C[2]);return C},colorize:function(D,C,E){if(E===undefined){E=50}return[D[0]-(D[0]-C[0])*(E/100),D[1]-(D[1]-C[1])*(E/100),D[2]-(D[2]-C[2])*(E/100),C[3]?C[3]:0.5]},pattern:function(G,C){G=parseInt(G);if(G>=0&&G<C){return G}var E=G/C;if(G>=C){var F=Math.floor(E)*(C);var D=(G-F);return D}if(G<0){var F=Math.ceil(E)*(C);var D=C-Math.abs((G-F));if(D>=C){var D=(D-C);return D}return D}},opacity:function(C,D){if(C[3]>1){C[3]=C[3]/255}if(C[3]==1){return[C[0],C[1],C[2],C[3]]}return[C[0]*(C[3])+D[0]*(1-C[3]),C[1]*(C[3])+D[1]*(1-C[3]),C[2]*(C[3])+D[2]*(1-C[3]),C[3]]},calc:function(C,E){switch(this.blend){case"opacity":var D=this.opacity(C,E);break;case"multiply":C[0]=(E[0]*C[0])/255;C[1]=(E[1]*C[1])/255;C[2]=(E[2]*C[2])/255;var D=this.opacity(C,E);break;case"screen":C[0]=255-(((255-E[0])*(255-C[0]))/255);C[1]=255-(((255-E[1])*(255-C[1]))/255);C[2]=255-(((255-E[2])*(255-C[2]))/255);var D=this.opacity(C,E);break;case"overlay":C[0]=(E[0]>128)?255-2*(255-C[0])*(255-E[0])/255:(E[0]*C[0]*2)/255;C[1]=(E[1]>128)?255-2*(255-C[1])*(255-E[1])/255:(E[1]*C[1]*2)/255;C[2]=(E[2]>128)?255-2*(255-C[2])*(255-E[2])/255:(E[2]*C[2]*2)/255;var D=this.opacity(C,E);break;case"difference":C[0]=Math.abs(C[0]-E[0]);C[1]=Math.abs(C[1]-E[1]);C[2]=Math.abs(C[2]-E[2]);var D=this.opacity(C,E);break;case"exclusion":C[0]=128-2*(E[0]-128)*(C[0]-128)/255;C[1]=128-2*(E[1]-128)*(C[1]-128)/255;C[2]=128-2*(E[2]-128)*(C[2]-128)/255;var D=this.opacity(C,E);break;case"darken":C[0]=(C[0]<E[0])?C[0]:E[0];C[1]=(C[1]<E[1])?C[1]:E[1];C[2]=(C[2]<E[2])?C[2]:E[2];var D=this.opacity(C,E);break;case"lighten":C[0]=(C[0]>E[0])?C[0]:E[0];C[1]=(C[1]>E[1])?C[1]:E[1];C[2]=(C[2]>E[2])?C[2]:E[2];var D=this.opacity(C,E);break;case"lineardodge":C[0]=E[0]+C[0];C[1]=E[1]+C[1];C[2]=E[2]+C[2];var D=this.opacity(C,E);break;case"linearlight":C[0]=E[0]+2*C[0]-255;C[1]=E[1]+2*C[1]-255;C[2]=E[2]+2*C[2]-255;var D=this.opacity(C,E);break;case"linearburn":C[0]=E[0]+C[0]-255;C[1]=E[1]+C[1]-255;C[2]=E[2]+C[2]-255;var D=this.opacity(C,E);break;case"softlight":C[0]=(E[0]>128)?255-((255-E[0])*(255-(C[0]-128)))/255:(E[0]*(C[0]+128))/255;C[1]=(E[1]>128)?255-((255-E[1])*(255-(C[1]-128)))/255:(E[1]*(C[1]+128))/255;C[2]=(E[2]>128)?255-((255-E[2])*(255-(C[2]-128)))/255:(E[2]*(C[2]+128))/255;var D=this.opacity(C,E);break;default:var D=[C[0],C[1],C[2],C[3]];break}return D},set:function(C,E){C=this.pattern(C,p);E=this.pattern(E,n);this.mixed=this.calc(this.rgba,this.get(C,E));var D=E*p*4+C*4;m.data[D]=this.mixed[0];m.data[D+1]=this.mixed[1];m.data[D+2]=this.mixed[2];m.data[D+3]=this.mixed[3]},get:function(C,E){C=this.pattern(C,p);E=this.pattern(E,n);var D=E*p*4+C*4;return[m.data[D],m.data[D+1],m.data[D+2],m.data[D+3]]}};var s=function(E){for(var C=0;C<p;C++){for(var F=0;F<n;F++){var D=q.get(C,F);D=E(D,C,F);q.rgba=D;q.set(C,F)}}};var a=function(F,H,D,G){if(H.elements!=undefined){var C=H.elements[F].x;var I=H.elements[F].y;var E=H.elements[F].size}else{if(H.origin=="random"){var C=d(0,p);var I=d(0,n);var E=d(D,G)}else{var C=parseInt((H.origin[0]/100)*p);var I=parseInt((H.origin[1]/100)*n);var E=d(D,G)}}return[C,I,E]};b.merge=function(G){G=o("merge",G);if(B[G.layer]===undefined){return this}var D=B[G.layer].getContext("2d");var E=D.getImageData(0,0,p,n);var I=E.data;for(var H=0;H<n;H++){for(var C=0;C<p;C++){var F=H*p*4+C*4;q.rgba=[I[F],I[F+1],I[F+2],I[F+3]];q.rgba[3]=(q.rgba[3]>1)?q.rgba[3]/255:q.rgba[3];q.set(C,H)}}g("merge",G);return this};b.copy=function(D){var G=m.pixels();var C=B[D].getContext("2d");var E=C.getImageData(0,0,p,n);var F=E.data;while(G--){m.data[G]=F[G]}g("copy",D);return this};b.brightness=function(C){C=o("brightness",C);q.blend="";s(function(D){if(C.legacy===true){return[Math.min(D[0]+C.adjust,255),Math.min(D[1]+C.adjust,255),Math.min(D[2]+C.adjust,255),D[3]]}else{C.adjust=Math.pow((C.adjust+100)/100,2);return[((((D[0]/255)-0.5)*C.adjust)+0.5)*255,((((D[1]/255)-0.5)*C.adjust)+0.5)*255,((((D[2]/255)-0.5)*C.adjust)+0.5)*255,D[3]]}});g("brightness",C);return this};b.contrast=function(D){D=o("contrast",D);var C=(100+D.adjust)/100;q.blend="";s(function(E){E[0]=((((E[0]/255)-0.5)*C)+0.5)*255;E[1]=((((E[1]/255)-0.5)*C)+0.5)*255;E[2]=((((E[2]/255)-0.5)*C)+0.5)*255;return[Math.max(Math.min(E[0],255),0),Math.max(Math.min(E[1],255),0),Math.max(Math.min(E[2],255),0),E[3]]});g("contrast",D);return this};b.grayscale=function(C){if(!C){C="average"}q.blend="";switch(C){case"ligthness":s(function(D){var E=Math.max(D[0],D[1],D[2])+Math.min(D[0],D[1],D[2]);return[E,E,E,D[3]]});break;case"average":s(function(D){var E=(D[0]+D[1]+D[2])/3;return[E,E,E,D[3]]});break;case"luminosity":s(function(E){var D=c.luminance(E);return[D,D,D,E[3]]});break}g("grayscale",C);return this};b.colorize=function(C){C=o("colorize",C);q.blend="";s(function(D){return q.colorize(D,C.rgb,C.level)});g("colorize",C);return this};b.invert=function(){params=o("invert",{});q.blend="";s(function(C){return[255-C[0],255-C[1],255-C[2],C[3]]});g("invert",params);return this};b.threshold=function(C){params=o("threshold",{},function(D){if(C!==undefined){D.threshold=C}return D});q.blend="";s(function(D){var E=((0.2126*D[0])+(0.7152*D[1])+(0.0722*D[2])<=params.threshold)?0:255;return[E,E,E,1]});g("threshold",params);return this};b.vibrance=function(D){D=o("vibrance",D);var C=D.adjust*-1;q.blend="";s(function(F){var G=(F[0]+F[1]+F[2])/3;var E=Math.max(F[0],F[1],F[2]);var H=((Math.abs(E-G)*2/255)*C)/100;if(F[0]!==E){F[0]+=(E-F[0])*H}if(F[1]!==E){F[1]+=(E-F[1])*H}if(F[2]!==E){F[2]+=(E-F[2])*H}return[F[0],F[1],F[2],F[3]]});g("vibrance",D);return this};b.waves=function(D){params=o("waves",D,function(H){if(H.xsines===undefined){H.xsines=d(1,10)}else{if(typeof H.xsines=="object"){H.xsines=d(H.xsines[0],H.xsines[1])}}if(H.ysines===undefined){H.ysines=d(1,10)}else{if(typeof H.ysines=="object"){H.ysines=d(H.ysines[0],H.ysines[1])}}if(H.rgba===undefined){var G=(H.opacity!==undefined)?H.opacity:1;H.rgba=f([[0,255],[0,255],[0,255],G])}return H});for(var C=0;C<p;C++){for(var F=0;F<n;F++){var E=127+63.5*Math.sin(C/p*params.xsines*2*3.1415)+63.5*Math.sin(F/n*params.ysines*2*3.1415);q.rgba=q.colorize([E,E,E,1],params.rgba,params.level);q.set(C,F)}}g("waves",params);return this};b.spheres=function(E){E=o("spheres",E,function(L){return L});var I=parseInt((E.sizeMin/100)*p);var D=parseInt((E.sizeMax/100)*n);var C=[];for(var F=0;F<E.count;F++){var K=a(F,E,I,D);var H=K[0];var G=K[1];var J=K[2];l.sphere(H,G,J,true,E.rgba);C.push({x:H,y:G,size:J})}E.elements=C;g("spheres",E);return this};b.crosshatch=function(D){params=o("crosshatch",D,function(G){if(G.xadjust==undefined){G.xadjust=d(1,10)}if(G.yadjust===undefined){G.yadjust=d(1,10)}if(G.rgba===undefined){G.rgba=[d(0,255),d(0,255),d(0,255),1]}return G});for(var C=0;C<p;C++){for(var F=0;F<n;F++){var E=127+63.5*Math.sin(C*C/params.xadjust)+63.5*Math.cos(F*F/params.yadjust);q.rgba=q.colorize([E,E,E,1],params.rgba,params.level);q.set(C,F)}}g("crosshatch",params);return this};b.squares=function(E){E=o("squares",E);var I=parseInt((E.sizeMin/100)*p);var D=parseInt((E.sizeMax/100)*n);var C=[];for(var F=0;F<E.count;F++){var K=a(F,E,I,D);var H=K[0];var G=K[1];var J=K[2];l.rect(H,G,J,J,false);C.push({x:H,y:G,size:J})}E.elements=C;g("squares",E);return this};b.circles=function(E){E=o("circles",E);var I=parseInt((E.sizeMin/100)*p);var D=parseInt((E.sizeMax/100)*n);var C=[];for(var F=0;F<E.count;F++){var K=a(F,E,I,D);var H=K[0];var G=K[1];var J=K[2];l.circle(H,G,J,true);C.push({x:H,y:G,size:J})}E.elements=C;g("circles",E);return this};b.lines=function(H){H=o("lines",H,function(I){I.s1=d(5,32);I.c1=d(5,32);return I});for(var F=0;F<H.count;F++){var D=p/2+Math.sin(F/H.s1)*p*0.7;var G=n/2+Math.cos(F/H.c1)*n*0.7;var C=p/2+Math.sin(F/H.c1)*p*0.7;var E=n/2+Math.cos(F/H.s1)*n*0.7;l.line(D,G,C,E)}g("lines",H);return this};b.noise=function(E){E=o("noise",E);for(var C=0;C<p;C++){for(var F=0;F<n;F++){if(E.mode=="color"){q.rgba=[d(0,255),d(0,255),d(0,255),E.opacity]}else{var D=d(0,255);q.rgba=[D,D,D,E.opacity]}q.set(C,F)}}g("noise",E);return this};b.test=function(){p=200;n=200;q.blend="opacity";q.rgba=[255,255,155,1];l.rect(1,1,p-2,n-2);var C=20;q.rgba=[0,150,0,0.6];l.rect(2,2,C,C);l.rect(p-C-2,2,C,C);l.rect(2,n-2-C,C,C);l.rect(p-2-C,n-2-C,C,C);q.rgba=[20,20,10,0.2];l.rect(p/2,n/2,178,178,true);q.rgba=[10,20,210,0.7];l.rect(p-5,n-5,10,10);var C=20;q.rgba=[0,0,0,1];l.line(C,C,p-C,n-C);l.line(p-C,C,C,n-C);l.line(0,n/2,p,n/2);l.line(p/2,0,p/2,n);q.rgba=[255,55,55,0.5];l.rect(10,10,p-20,n-20);q.rgba=[0,0,255,0.3];l.rect(p-2,n-2,4,4);q.rgba=[255,255,255,1];q.set(0,0);q.set(p-1,0);q.set(0,n-1);q.set(p-1,n-1);q.rgba=[25,25,0,0.2];l.circle(p/4,n/4,p/4,true);q.rgba=[255,255,0,0.1];l.circle(p,n,p,true);this.brightness(50,true);this.vibrance(100);this.contrast(20);return this};b.fill=function(C){o("fill",C);l.rect(1,1,p,n);g("fill",C);return this};b.toImage=function(D){var F=D.createImageData(p,n);var E=F.data;var G=m.pixels();for(var C=0;C<G;C+=4){E[C]=m.data[C];E[C+1]=m.data[C+1];E[C+2]=m.data[C+2];E[C+3]=255}return F};b.toCanvas=function(){var C=document.createElement("canvas");C.width=p;C.height=n;var D=C.getContext("2d");var E=this.toImage(D);D.putImageData(E,0,0);return C};b.getCanvas=function(C){if(C){C(B[B.length-1])}return this};b.getPhases=function(F){if(F){var C=[];var E=B.length;for(var D=0;D<E;D++){C.push(B[D])}F(C)}return this};b.stat=function(C){i.stop=new Date().getTime();i.elapsed=(i.stop-i.start)/1000;if(C){C(i)}return this};b.history={list:function(){return JSON.parse(localStorage.getItem(w))||[]},last:function(){return r[r.length-1]},get:function(C){return r[C]},add:function(C){if(!k){return}if(C==undefined){var G=new Date();var D=z.length;var E=B.length;C=G.getHours()+":"+G.getMinutes()+":"+G.getSeconds()+" l"+E+" i"+D}r=JSON.parse(localStorage.getItem(w))||[];if(r.length>=k){r.shift()}var F={name:C,width:p,height:n,items:z};r.push(F);localStorage.setItem(w,JSON.stringify(r))}};b.params=function(E,D){var H=0;if(E.width!=undefined){p=E.width}if(E.height!=undefined){n=E.height}x();if(D!=true){v()}for(var F in E.items){y=E.items[F][0];var G=E.items[F][1];var C=E.items[F][2];if(H!=y){if(B[y]!=undefined){m.set(B[y])}else{m.clear()}H=y}switch(G){default:if(b[G]==undefined){console.warn("undefined effect: "+G)}else{b[G](C)}break}B[y]=b.toCanvas()}b.history.add();return this};return b};