/*
 * tgen.js - the seamless texture generator
 * https://github.com/schalkt/tgen
 *
 * Copyright (c) 2015 Tamas Schalk
 * MIT license
 *
 * @version 0.1
 *
 */
var tgen=function(p,n){var b={};var A=[];var y=[];var i={};var x=0;var z=false;var k=15;var w="history";var r=[];b.blends=["opacity","multiply","screen","overlay","difference","exclusion","darken","lighten","lineardodge","linearlight","linearburn","softlight"];if(p==undefined){p=256}if(n==undefined){n=p}var v=function(){m.clear();A=[];y=[];x=0;i.start=new Date().getTime()};var m={data:null,pixels:function(){return p*n*4},clear:function(){this.data=new Float32Array(p*n*4)},set:function(B){var F=this.pixels();var C=B.getContext("2d");var D=C.getImageData(0,0,p,n);var E=D.data;while(F--){m.data[F]=E[F]}},opacity:function(B){if(B===undefined){B=0.5}var D=this.pixels();for(var C=0;C<D;C=C+4){m.data[C]=B}return this}};v();var h=function(E,D){var C={};for(var B in E){C[B]=E[B]}for(var B in D){C[B]=D[B]}return C};var d=function(C,B){return Math.floor(Math.random()*(B-C+1))+C};var e=function(C,B){return Math.random()*(B-C)+C};var t=function(B){if(B===undefined){B=1}if(B===true){B=0.5+(Math.random()/2)}return[d(0,255),d(0,255),d(0,255),B]};var u=function(){var C=b.blends.length;var B=d(0,C-1);return b.blends[B]};b.defaults={fill:{blend:"opacity",rgba:[128,128,228,1]},merge:{blend:"opacity",opacity:0.5},noise:{blend:"random",mode:"monochrome",opacity:0.5},colorize:{level:50,rgb:"random"},vibrance:{adjust:50},contrast:{adjust:50},threshold:{threshold:96},invert:{},brightness:{adjust:50,legacy:true},waves:{blend:"random",level:50},crosshatch:{blend:"random",level:50},lines:{blend:"softlight",rgba:"random",count:200,sizeMin:10,sizeMax:120},circles:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:15},spheres:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:20,sizeMax:70},squares:{blend:"lighten",rgba:"random",origin:"random",count:21,sizeMin:1,sizeMax:50}};var f=function(B){if(B==="random"){B=t(true)}if(typeof B[0]=="object"){B[0]=d(B[0][0],B[0][1])}if(typeof B[1]=="object"){B[1]=d(B[1][0],B[1][1])}if(typeof B[2]=="object"){B[2]=d(B[2][0],B[2][1])}if(typeof B[3]=="object"){B[3]=e(B[3][0],B[3][1])}return B};var o=function(C,E,D){if(E===undefined){E=h({},b.defaults[C])}else{E=h(b.defaults[C],E)}if(D!==undefined){E=D(E)}if(typeof E.count=="object"){E.count=d(E.count[0],E.count[1])}if(E.blend===undefined||E.blend===null){E.blend=""}if(E.blend==="random"){E.blend=u()}if(typeof E.blend=="object"){var B=E.blend.length;E.blend=E.blend[d(0,B-1)]}if(E.blend!==undefined){q.blend=E.blend}else{q.blend=""}if(E.rgba){E.rgba=f(E.rgba);q.rgba=E.rgba}if(E.rgb){E.rgb=f(E.rgb);q.rgba=E.rgb}return E};var j=function(B,C){if(z){console.log(x,B,C)}};var g=function(B,C){y.push([x,B,C]);j(B,C)};var l={rect:function(J,I,C,B,H){if(H!==undefined){var G=parseInt(-C/2);var F=parseInt(-B/2)}else{var G=0;var F=0}for(var E=0;E<C;E++){for(var D=0;D<B;D++){q.set(G+J+E,F+I+D)}}},circle:function(B,I,F,G){if(G!==undefined){var E=0;var C=0}else{var E=F;var C=F}for(var J=-F;J<F;J++){var D=parseInt(Math.sqrt(F*F-J*J));for(var H=-D;H<D;H++){q.set(B+E+J,I+C+H)}}},line:function(C,H,B,G){var E=Math.sqrt((B-C)*(B-C)+(G-H)*(G-H));var K=(B-C)/E;var J=(G-H)/E;var I=0;var F=0;for(var D=0;D<E;D++){I=C+(K*D);F=H+(J*D);q.set(I,F)}},sphere:function(B,K,G,H,C){if(H!==undefined){var F=0;var D=0}else{var F=G;var D=G}for(var L=-G;L<G;L++){var E=parseInt(Math.sqrt(G*G-L*L));for(var J=-E;J<E;J++){var I=Math.min(255,Math.max(0,(255-255*Math.sqrt((J*J)+(L*L))/(G/2))));q.rgba=[(C[0]/255)*I,(C[1]/255)*I,(C[2]/255)*I,C[3]];q.set(B+F+L,K+D+J)}}}};var c={luminance:function(B){return(0.21*B[0])+(0.72*B[1])+(0.07*B[2])}};var q={rgba:[0,0,0,1],mixed:[0,0,0,1],blend:"opacity",normalize:function(B){B[0]=Math.round(B[0]);B[1]=Math.round(B[1]);B[2]=Math.round(B[2]);return B},colorize:function(C,B,D){if(D===undefined){D=50}return[C[0]-(C[0]-B[0])*(D/100),C[1]-(C[1]-B[1])*(D/100),C[2]-(C[2]-B[2])*(D/100),B[3]?B[3]:0.5]},pattern:function(F,B){F=parseInt(F);if(F>=0&&F<B){return F}var D=F/B;if(F>=B){var E=Math.floor(D)*(B);var C=(F-E);return C}if(F<0){var E=Math.ceil(D)*(B);var C=B-Math.abs((F-E));if(C>=B){var C=(C-B);return C}return C}},opacity:function(B,C){if(B[3]>1){B[3]=B[3]/255}if(B[3]==1){return[B[0],B[1],B[2],B[3]]}return[B[0]*(B[3])+C[0]*(1-B[3]),B[1]*(B[3])+C[1]*(1-B[3]),B[2]*(B[3])+C[2]*(1-B[3]),B[3]]},calc:function(B,D){switch(this.blend){case"opacity":var C=this.opacity(B,D);break;case"multiply":B[0]=(D[0]*B[0])/255;B[1]=(D[1]*B[1])/255;B[2]=(D[2]*B[2])/255;var C=this.opacity(B,D);break;case"screen":B[0]=255-(((255-D[0])*(255-B[0]))/255);B[1]=255-(((255-D[1])*(255-B[1]))/255);B[2]=255-(((255-D[2])*(255-B[2]))/255);var C=this.opacity(B,D);break;case"overlay":B[0]=(D[0]>128)?255-2*(255-B[0])*(255-D[0])/255:(D[0]*B[0]*2)/255;B[1]=(D[1]>128)?255-2*(255-B[1])*(255-D[1])/255:(D[1]*B[1]*2)/255;B[2]=(D[2]>128)?255-2*(255-B[2])*(255-D[2])/255:(D[2]*B[2]*2)/255;var C=this.opacity(B,D);break;case"difference":B[0]=Math.abs(B[0]-D[0]);B[1]=Math.abs(B[1]-D[1]);B[2]=Math.abs(B[2]-D[2]);var C=this.opacity(B,D);break;case"exclusion":B[0]=128-2*(D[0]-128)*(B[0]-128)/255;B[1]=128-2*(D[1]-128)*(B[1]-128)/255;B[2]=128-2*(D[2]-128)*(B[2]-128)/255;var C=this.opacity(B,D);break;case"darken":B[0]=(B[0]<D[0])?B[0]:D[0];B[1]=(B[1]<D[1])?B[1]:D[1];B[2]=(B[2]<D[2])?B[2]:D[2];var C=this.opacity(B,D);break;case"lighten":B[0]=(B[0]>D[0])?B[0]:D[0];B[1]=(B[1]>D[1])?B[1]:D[1];B[2]=(B[2]>D[2])?B[2]:D[2];var C=this.opacity(B,D);break;case"lineardodge":B[0]=D[0]+B[0];B[1]=D[1]+B[1];B[2]=D[2]+B[2];var C=this.opacity(B,D);break;case"linearlight":B[0]=D[0]+2*B[0]-255;B[1]=D[1]+2*B[1]-255;B[2]=D[2]+2*B[2]-255;var C=this.opacity(B,D);break;case"linearburn":B[0]=D[0]+B[0]-255;B[1]=D[1]+B[1]-255;B[2]=D[2]+B[2]-255;var C=this.opacity(B,D);break;case"softlight":B[0]=(D[0]>128)?255-((255-D[0])*(255-(B[0]-128)))/255:(D[0]*(B[0]+128))/255;B[1]=(D[1]>128)?255-((255-D[1])*(255-(B[1]-128)))/255:(D[1]*(B[1]+128))/255;B[2]=(D[2]>128)?255-((255-D[2])*(255-(B[2]-128)))/255:(D[2]*(B[2]+128))/255;var C=this.opacity(B,D);break;default:var C=[B[0],B[1],B[2],B[3]];break}return C},set:function(B,D){B=this.pattern(B,p);D=this.pattern(D,n);this.mixed=this.calc(this.rgba,this.get(B,D));var C=D*p*4+B*4;m.data[C]=this.mixed[0];m.data[C+1]=this.mixed[1];m.data[C+2]=this.mixed[2];m.data[C+3]=this.mixed[3]},get:function(B,D){B=this.pattern(B,p);D=this.pattern(D,n);var C=D*p*4+B*4;return[m.data[C],m.data[C+1],m.data[C+2],m.data[C+3]]}};var s=function(D){for(var B=0;B<p;B++){for(var E=0;E<n;E++){var C=q.get(B,E);C=D(C,B,E);q.rgba=C;q.set(B,E)}}};var a=function(E,G,C,F){if(G.elements!=undefined){var B=G.elements[E].x;var H=G.elements[E].y;var D=G.elements[E].size}else{if(G.origin=="random"){var B=d(0,p);var H=d(0,n);var D=d(C,F)}else{var B=parseInt((G.origin[0]/100)*p);var H=parseInt((G.origin[1]/100)*n);var D=d(C,F)}}return[B,H,D]};b.merge=function(F){F=o("merge",F);if(A[F.layer]===undefined){return this}var C=A[F.layer].getContext("2d");var D=C.getImageData(0,0,p,n);var H=D.data;for(var G=0;G<n;G++){for(var B=0;B<p;B++){var E=G*p*4+B*4;q.rgba=[H[E],H[E+1],H[E+2],H[E+3]];q.rgba[3]=(q.rgba[3]>1)?q.rgba[3]/255:q.rgba[3];q.set(B,G)}}g("merge",F);return this};b.copy=function(C){var F=m.pixels();var B=A[C].getContext("2d");var D=B.getImageData(0,0,p,n);var E=D.data;while(F--){m.data[F]=E[F]}g("copy",C);return this};b.brightness=function(B){B=o("brightness",B);q.blend="";s(function(C){if(B.legacy===true){return[Math.min(C[0]+B.adjust,255),Math.min(C[1]+B.adjust,255),Math.min(C[2]+B.adjust,255),C[3]]}else{B.adjust=Math.pow((B.adjust+100)/100,2);return[((((C[0]/255)-0.5)*B.adjust)+0.5)*255,((((C[1]/255)-0.5)*B.adjust)+0.5)*255,((((C[2]/255)-0.5)*B.adjust)+0.5)*255,C[3]]}});g("brightness",B);return this};b.contrast=function(C){C=o("contrast",C);var B=(100+C.adjust)/100;q.blend="";s(function(D){D[0]=((((D[0]/255)-0.5)*B)+0.5)*255;D[1]=((((D[1]/255)-0.5)*B)+0.5)*255;D[2]=((((D[2]/255)-0.5)*B)+0.5)*255;return[Math.max(Math.min(D[0],255),0),Math.max(Math.min(D[1],255),0),Math.max(Math.min(D[2],255),0),D[3]]});g("contrast",C);return this};b.grayscale=function(B){if(!B){B="average"}q.blend="";switch(B){case"ligthness":s(function(C){var D=Math.max(C[0],C[1],C[2])+Math.min(C[0],C[1],C[2]);return[D,D,D,C[3]]});break;case"average":s(function(C){var D=(C[0]+C[1]+C[2])/3;return[D,D,D,C[3]]});break;case"luminosity":s(function(D){var C=c.luminance(D);return[C,C,C,D[3]]});break}g("grayscale",B);return this};b.colorize=function(B){B=o("colorize",B);q.blend="";s(function(C){return q.colorize(C,B.rgb,B.level)});g("colorize",B);return this};b.invert=function(){params=o("invert",{});q.blend="";s(function(B){return[255-B[0],255-B[1],255-B[2],B[3]]});g("invert",params);return this};b.threshold=function(B){params=o("threshold",{},function(C){if(B!==undefined){C.threshold=B}return C});q.blend="";s(function(C){var D=((0.2126*C[0])+(0.7152*C[1])+(0.0722*C[2])<=params.threshold)?0:255;return[D,D,D,1]});g("threshold",params);return this};b.vibrance=function(C){C=o("vibrance",C);var B=C.adjust*-1;q.blend="";s(function(E){var F=(E[0]+E[1]+E[2])/3;var D=Math.max(E[0],E[1],E[2]);var G=((Math.abs(D-F)*2/255)*B)/100;if(E[0]!==D){E[0]+=(D-E[0])*G}if(E[1]!==D){E[1]+=(D-E[1])*G}if(E[2]!==D){E[2]+=(D-E[2])*G}return[E[0],E[1],E[2],E[3]]});g("vibrance",C);return this};b.waves=function(C){params=o("waves",C,function(G){if(G.xsines===undefined){G.xsines=d(1,10)}else{if(typeof G.xsines=="object"){G.xsines=d(G.xsines[0],G.xsines[1])}}if(G.ysines===undefined){G.ysines=d(1,10)}else{if(typeof G.ysines=="object"){G.ysines=d(G.ysines[0],G.ysines[1])}}if(G.rgba===undefined){var F=(G.opacity!==undefined)?G.opacity:1;G.rgba=f([[0,255],[0,255],[0,255],F])}return G});for(var B=0;B<p;B++){for(var E=0;E<n;E++){var D=127+63.5*Math.sin(B/p*params.xsines*2*3.1415)+63.5*Math.sin(E/n*params.ysines*2*3.1415);q.rgba=q.colorize([D,D,D,1],params.rgba,params.level);q.set(B,E)}}g("waves",params);return this};b.spheres=function(D){D=o("spheres",D,function(K){return K});var H=parseInt((D.sizeMin/100)*p);var C=parseInt((D.sizeMax/100)*n);var B=[];for(var E=0;E<D.count;E++){var J=a(E,D,H,C);var G=J[0];var F=J[1];var I=J[2];l.sphere(G,F,I,true,D.rgba);B.push({x:G,y:F,size:I})}D.elements=B;g("spheres",D);return this};b.crosshatch=function(C){params=o("crosshatch",C,function(F){if(F.xadjust==undefined){F.xadjust=d(1,10)}if(F.yadjust===undefined){F.yadjust=d(1,10)}if(F.rgba===undefined){F.rgba=[d(0,255),d(0,255),d(0,255),1]}return F});for(var B=0;B<p;B++){for(var E=0;E<n;E++){var D=127+63.5*Math.sin(B*B/params.xadjust)+63.5*Math.cos(E*E/params.yadjust);q.rgba=q.colorize([D,D,D,1],params.rgba,params.level);q.set(B,E)}}g("crosshatch",params);return this};b.squares=function(D){D=o("squares",D);var H=parseInt((D.sizeMin/100)*p);var C=parseInt((D.sizeMax/100)*n);var B=[];for(var E=0;E<D.count;E++){var J=a(E,D,H,C);var G=J[0];var F=J[1];var I=J[2];l.rect(G,F,I,I,false);B.push({x:G,y:F,size:I})}D.elements=B;g("squares",D);return this};b.circles=function(D){D=o("circles",D);var H=parseInt((D.sizeMin/100)*p);var C=parseInt((D.sizeMax/100)*n);var B=[];for(var E=0;E<D.count;E++){var J=a(E,D,H,C);var G=J[0];var F=J[1];var I=J[2];l.circle(G,F,I,true);B.push({x:G,y:F,size:I})}D.elements=B;g("circles",D);return this};b.lines=function(G){G=o("lines",G,function(H){H.s1=d(5,32);H.c1=d(5,32);return H});for(var E=0;E<G.count;E++){var C=p/2+Math.sin(E/G.s1)*p*0.7;var F=n/2+Math.cos(E/G.c1)*n*0.7;var B=p/2+Math.sin(E/G.c1)*p*0.7;var D=n/2+Math.cos(E/G.s1)*n*0.7;l.line(C,F,B,D)}g("lines",G);return this};b.noise=function(D){D=o("noise",D);for(var B=0;B<p;B++){for(var E=0;E<n;E++){if(D.mode=="color"){q.rgba=[d(0,255),d(0,255),d(0,255),D.opacity]}else{var C=d(0,255);q.rgba=[C,C,C,D.opacity]}q.set(B,E)}}g("noise",D);return this};b.test=function(){p=200;n=200;q.blend="opacity";q.rgba=[255,255,155,1];l.rect(1,1,p-2,n-2);var B=20;q.rgba=[0,150,0,0.6];l.rect(2,2,B,B);l.rect(p-B-2,2,B,B);l.rect(2,n-2-B,B,B);l.rect(p-2-B,n-2-B,B,B);q.rgba=[20,20,10,0.2];l.rect(p/2,n/2,178,178,true);q.rgba=[10,20,210,0.7];l.rect(p-5,n-5,10,10);var B=20;q.rgba=[0,0,0,1];l.line(B,B,p-B,n-B);l.line(p-B,B,B,n-B);l.line(0,n/2,p,n/2);l.line(p/2,0,p/2,n);q.rgba=[255,55,55,0.5];l.rect(10,10,p-20,n-20);q.rgba=[0,0,255,0.3];l.rect(p-2,n-2,4,4);q.rgba=[255,255,255,1];q.set(0,0);q.set(p-1,0);q.set(0,n-1);q.set(p-1,n-1);q.rgba=[25,25,0,0.2];l.circle(p/4,n/4,p/4,true);q.rgba=[255,255,0,0.1];l.circle(p,n,p,true);this.brightness(50,true);this.vibrance(100);this.contrast(20);return this};b.fill=function(B){o("fill",B);l.rect(1,1,p,n);g("fill",B);return this};b.toImage=function(C){var E=C.createImageData(p,n);var D=E.data;var F=m.pixels();for(var B=0;B<F;B+=4){D[B]=m.data[B];D[B+1]=m.data[B+1];D[B+2]=m.data[B+2];D[B+3]=255}return E};b.toCanvas=function(){var B=document.createElement("canvas");B.width=p;B.height=n;var C=B.getContext("2d");var D=this.toImage(C);C.putImageData(D,0,0);return B};b.getCanvas=function(B){if(B){B(A[A.length-1])}return this};b.getPhases=function(E){if(E){var B=[];var D=A.length;for(var C=0;C<D;C++){B.push(A[C])}E(B)}return this};b.stat=function(B){i.stop=new Date().getTime();i.elapsed=(i.stop-i.start)/1000;if(B){B(i)}return this};b.history={list:function(){return JSON.parse(localStorage.getItem(w))||[]},last:function(){return r[r.length-1]},get:function(B){return r[B]},add:function(B){if(!k){return}if(B==undefined){var F=new Date();var C=y.length;var D=A.length;B=F.getHours()+""+F.getMinutes()+""+F.getSeconds()+" layer"+D+" item"+C}r=JSON.parse(localStorage.getItem(w))||[];if(r.length>=k){r.shift()}var E={name:B,width:p,height:n,items:y};r.push(E);localStorage.setItem(w,JSON.stringify(r))}};b.params=function(E,D){var I=0;if(E.width!=undefined){p=E.width}if(E.height!=undefined){n=E.height}if(D!=true){v()}for(var F in E.items){x=E.items[F][0];var G=E.items[F][1];var C=E.items[F][2];if(I!=x){if(A[x]!=undefined){m.set(A[x])}else{m.clear()}I=x}switch(G){case"merge2":for(var B in C){var H={layer:C[B][0]};if(C[B][1]!==undefined){H.blend=C[B][1]}if(C[B][2]!==undefined){H.opacity=C[B][2]}b.merge(H)}break;default:if(b[G]==undefined){console.warn("undefined effect: "+G)}else{b[G](C)}break}A[x]=b.toCanvas()}b.history.add();return this};return b};